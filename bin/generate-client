#!/usr/bin/env node

const fs = require("fs");
const ejs = require("ejs");
const path = require("path");
const prettier = require("prettier");
const pluralize = require("pluralize");
const { promisify } = require("util");

const writeFile = promisify(fs.writeFile);

const writeCode = (file, code) => {
  return writeFile(file, prettier.format(code, { parser: "typescript" }));
};

const toGeneratedName = name => {
  return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
};

const withDefaults = items => {
  return items.map(item => ({
    plural: pluralize(item.name),
    type: item.name,
    generatedType: toGeneratedName(item.name),
    ...item
  }));
}

const client = path.join(__dirname, "../gen/client.ejs");
const types = path.join(__dirname, "../gen/types.ejs");

const data = {
  objects: withDefaults(require("../gen/input.json"))
};

Promise.all([
  ejs.render(client, data).then(code => writeCode("src/Kubernetes.ts", code)),
  ejs.render(types, data).then(code => writeCode("src/types/objects.ts", code))
]).catch(console.error);
